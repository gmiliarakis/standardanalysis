% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/subsample_loop_functions.R
\name{rarefy_multiple}
\alias{rarefy_multiple}
\alias{calculate_alpha_df}
\alias{calculate_average_alpha_ps}
\alias{multiple_test_alpha}
\alias{multiple_permanova}
\alias{permanova_average}
\title{Subsample-loop}
\usage{
rarefy_multiple(
  pseq,
  sample.size = NULL,
  iter = 10,
  replace = FALSE,
  seeds = NULL,
  ...
)

calculate_alpha_df(pseq_list, measures = NULL)

calculate_average_alpha_ps(
  alpha_dataframe,
  alpha_div = NULL,
  averagef = "median"
)

multiple_test_alpha(
  alpha_dataframe,
  pseq,
  alpha_div,
  variable,
  method = "wilcox.test",
  pair_by = NULL
)

multiple_permanova(
  pseq_list,
  distance,
  variable,
  permutations,
  pseudocount = 1,
  ps_ref = NULL,
  longit = NULL,
  ...
)

permanova_average(results_adonis, averagef = "median", plot = FALSE)
}
\arguments{
\item{pseq}{Your original \code{phyloseq} object for the metadata.}

\item{sample.size}{Numeric. Your preferred sample size for rarefying.}

\item{iter}{Numeric. The amount of times you would like to rarefy (amount of comparisons).}

\item{replace}{Logical. Perform subsampling with replacement or without (\code{TRUE} or \code{FALSE}).}

\item{seeds}{Vector of random seeds that you want to use. Possible to leave empty and have seed range to be 1:iterations.}

\item{...}{Additional arguments passed to adonis2.}

\item{pseq_list}{(5) List or vector of rarefied \code{phyloseq} objects (from \code{rarefy_multiple}).}

\item{measures}{Character. The alpha-diversity measure(s) you want to compute.}

\item{alpha_dataframe}{(4) The \code{data.frame} with alpha-diversities received from \code{calculate_alpha_df}.}

\item{alpha_div}{Character. The alpha-diversity measures that you want to test.}

\item{averagef}{Character. The averaging function to use. One of \code{"median"}, \code{"mean"}, \code{"min"}, or \code{"max"}.
Default (and recommended) is \code{"median"}.}

\item{variable}{Character. Metadata variable(s) to test (e.g., \code{"Group"} or \code{"Var1 + Var2"}).}

\item{method}{Character. which test should be performed.}

\item{pair_by}{Character. In case of paired analysis, which is variable is the data paired on.}

\item{distance}{Character. Distance metric to use (e.g., \code{"bray"}, \code{"aitchison"}).}

\item{permutations}{Integer. Number of permutations for PERMANOVA.}

\item{pseudocount}{Numeric. Pseudocount to add to OTU table for Aitchison distance (default: 1).}

\item{ps_ref}{Optional. Reference \code{phyloseq} object for metadata subsetting.}

\item{longit}{Optional. Name of metadata variable for paired/longitudinal analysis.}

\item{results_adonis}{A vector or list of PERMANOVA results as received from the \code{multiple_permanova}.}

\item{plot}{Logical. If \code{TRUE}, boxplots of pseudo-F statistics and p-values across rarefactions are displayed for the first variable.
Default is \code{FALSE}.}
}
\value{
(1) A list of \code{phyloseq} objects with length of amount of \code{iter}

(2) A \code{data.frame} with the alpha-diversities requested for each \code{phyloseq} object.

(3) A dataframe with the average alpha-diversities.

(4) A vector with the p-values for each \code{phyloseq} object.

(5) A list of adonis2 results, one per rarefied dataset.

A named list containing:
  \describe{
    \item{summary}{A data frame with variable names as row names and three columns:
      \describe{
        \item{<averagef>.F}{The aggregated pseudo-F statistic for each variable (e.g., median.F).}
        \item{<averagef>.p}{The aggregated p-value for each variable (e.g., median.p).}
        \item{Cauchy.p}{The aggregated p-value for each variable computed using the Aggregated Cauchy Association Test (ACAT).}
      }
    }
    \item{Fvals}{A named list of pseudo-F statistic vectors, one for each variable across all rarefactions.}
    \item{pvals}{A named list of p-value vectors, one for each variable across all rarefactions.}
    \item{plots}{(Optional) If \code{plot = TRUE}, a list containing two ggplot objects:
      \describe{
        \item{f}{Boxplot of pseudo-F statistics for the first variable.}
        \item{p}{Boxplot of p-values for the first variable with ACAT p-value indicated by a red dashed line.}
      }
    }
  }
}
\description{
This suite of functions provides a workflow for performing and analyzing multiple rarefactions (random subsampling) of a \code{phyloseq} object. Multiple rarefactions help assess the variability and robustness of diversity and community composition metrics to subsampling.

Most functions in this workflow (except \code{permanova_average}) support parallel execution using the \code{future} framework via \code{future.apply::future_lapply()}. This allows you to take advantage of multiple CPU cores or nodes to speed up computation, which is especially useful for large datasets or high-performance computing (HPC) environments.

\strong{Getting started:}
\enumerate{
  \item Install the required package for parallelization:
    \itemize{
      \item \code{install.packages("future.apply")}
    }
  \item Before running these functions, set up your parallel backend using the \code{future} package. For example, to use all available cores on your machine:
    \itemize{
      \item \code{future::plan("multisession", workers = parallel::detectCores())}
    }
  \item For more information on available parallelization strategies and how to choose the best plan for your system (e.g., multicore, cluster, etc.), see the \href{https://future.futureverse.org/reference/plan.html}{future package documentation}.
  \item You can control the number of parallel workers via the \code{workers} argument (or \code{mc.cores} for some backends).
  \item For reproducible results in parallel, set the random number generator kind to L'Ecuyer-CMRG.
  \item Example setup:
    \itemize{
      \item \code{future::plan("multisession", workers = 4)}
      \item \code{base::RNGkind("L'Ecuyer-CMRG")}
    }
}

The main steps in the workflow are:
\enumerate{
  \item \code{rarefy_multiple}: Create multiple rarefied versions of your phyloseq object.
  \item \code{calculate_alpha_df}: Calculate alpha-diversity metrics for each rarefied object.
  \item \code{calculate_average_alpha_ps}: Summarize alpha-diversity metrics across rarefactions.
  \item \code{multiple_test_alpha}: Test for group differences in alpha-diversity across rarefactions.
  \item \code{multiple_permanova}: Run PERMANOVA on each rarefied object to assess group differences in community composition.
  \item \code{permanova_average}: Aggregate and summarize PERMANOVA results across rarefactions.
}

See the Details section for further information on each function.
}
\details{
(1) \code{rarefy_multiple} performs multiple rarefactions (random subsampling without or with replacement) on a \code{phyloseq} object. For each iteration, the function applies \code{\link[phyloseq]{rarefy_even_depth}} using a specified or automatically generated random seed. The result is a list of rarefied \code{phyloseq} objects, each representing a different random subsample at the specified depth. Rarefaction parameters (depth and replacement) are stored as attributes in the output list for reference.

(2) \code{calculate_alpha_df} calculates alpha-diversity metrics for each rarefied \code{phyloseq} object in the input list. It applies `phyloseq::estimate_richness` to each object, optionally for a user-specified set of diversity measures. The results are combined into a single data frame, with each row corresponding to a sample from a particular rarefaction. This allows downstream analyses of the distribution of alpha-diversity across rarefactions.

(3) \code{calculate_average_alpha_ps} summarizes alpha-diversity values across multiple rarefactions for each sample. For each alpha-diversity metric, it computes the specified summary statistic (median, mean, min, or max) across all rarefied datasets. The output is a data frame where each row corresponds to a sample and each column to a summarized diversity measure. This facilitates comparison of central tendencies or ranges of diversity estimates across samples.

(4) \code{multiple_test_alpha} tests for differences in alpha-diversity between groups, separately for each rarefied dataset. Supported statistical tests include t-test, Wilcoxon rank-sum, Kruskal-Wallis, and Friedman test, with optional support for paired data. For each rarefied dataset, the appropriate test is applied to compare groups defined by a metadata variable. The output is a vector of p-values, one for each rarefaction, which can be aggregated or visualized to assess the robustness of group differences to subsampling variation.

(4) \code{multiple_permanova} runs PERMANOVA (\code{\link[vegan]{adonis2}} ) on each rarefied \code{phyloseq} object to test for group differences in community composition. The specified distance metric (e.g., Bray-Curtis, Aitchison) is computed for each rarefied dataset, and the PERMANOVA is performed using the provided metadata variable(s). If a longitudinal variable is specified, permutation blocks are set up accordingly. The output is a list of adonis2 result objects, one per rarefied dataset, allowing assessment of the consistency of PERMANOVA results across rarefactions.

(5) \code{permanova_average} aggregates PERMANOVA results obtained from \code{\link[vegan]{adonis2}} on multiple rarefied \code{phyloseq} objects, the output of \code{multiple_permanova}.
It handles multiple variables from the adonis2 output and computes summary statistics (median, mean, min, or max) of the PERMANOVA pseudo-F statistics and p-values for each variable separately.
P-values are combined using the ACAT method (\code{\link{acat}}) for a robust overall significance measure for each variable.
If \code{plot = TRUE}, boxplots visualize the distribution of pseudo-F statistics and p-values for the first variable, with the ACAT p-value indicated by a red dashed line.
}
\section{Functions}{
\itemize{
\item \code{rarefy_multiple()}: Creating multiple subsampled (rarefied) \code{phyloseq} objects

\item \code{calculate_alpha_df()}: Calculating alpha-diversities

\item \code{calculate_average_alpha_ps()}: Calculating of the averages of alpha-diversities

\item \code{multiple_test_alpha()}: Testing of alpha-diversities between groups

\item \code{multiple_permanova()}: Run PERMANOVA on Multiple Rarefied Phyloseq Objects

\item \code{permanova_average()}: Aggregate PERMANOVA Results Across Multiple Rarefactions

}}
\examples{
pseq_list <- rarefy_multiple(pseq, sample.size = 8000, iter = 100)
alpha_df <- calculate_alpha_df(pseq_list, measures = c("Shannon", "Simpson", "Chao1"))
average_alphas <- calculate_average_alpha_ps(alpha_df, alpha_div = c("Shannon", "Simpson"), averagef = "min")
alpha_pvals <- multiple_test_alpha(alpha_df, pseq, alpha_div = "Shannon", variable = "HealthStatus", method = "wilcoxon.test", pair_by = "SubjectID")
median(alpha_pvals)
permanova_results <- multiple_permanova(pseq_list, distance = "aitchison", variable = "Source", permutations = 9999, longit = "SubjectID")

\dontrun{
# Run multiple PERMANOVAs
adonis_results <- multiple_permanova(
  pseq_list = rarefied_list,
  distance = "bray",
  variable = "treatment + timepoint",
  permutations = 999
)

# Aggregate results across rarefactions
results <- permanova_average(adonis_results, averagef = "median", plot = FALSE)

# View summary table
results$summary

# Access F-values for a specific variable
results$Fvals$treatment

# Access p-values for a specific variable
results$pvals$treatment

# Create plots
results_with_plots <- permanova_average(adonis_results, averagef = "median", plot = TRUE)
results_with_plots$plots$f
results_with_plots$plots$p
}
}
\references{
Liu, Y., & Xie, J. (2019).
Cauchy Combination Test: A Powerful Test With Analytic p-Value Calculation Under Arbitrary Dependency Structures.
\emph{Journal of the American Statistical Association}, \bold{115}(529), 393–402.
\doi{10.1080/01621459.2018.1554485}
}
